jobs:
  build:
    # Circle CI (base image):
    # Each command line is run in `/bin/bash -eo pipefail`.
    # The start dir is ~/project, there is a helper to create the checkout
    docker:
      - image: cimg/base:2020.01
    steps:

    - run: sudo apt-get update && sudo apt-get install -y bc moreutils curl npm
    - run: sudo npm install -g git+https://github.com/dotmpe/tap-xunit.git

    # Invoke CCI helper.
    - checkout

    # Go move checkout to a default build location ~/project/user-conf
    - run:
        name: Move checkout
        command: |
            echo "$(whoami)@$(hostname -f):$PWD"; cd; \
            mv ~/project/ ~/user-conf; \
            mkdir ~/project; \
            mv ~/user-conf/ ~/project/; \
            ln -s ~/project/user-conf ~/bin; \
            cd ~/project/user-conf

    - run:
        name: Build
        command: |
            cd ~/project/user-conf; \
            set -euo pipefail; \
            export TERM=xterm \
              VND_SRC_PREFIX=$HOME/build \
              U_S=$PWD \
              ENV_DEV=1 \
              SCRIPT_SHELL=bash \
              CS=dark \
              CTX_PID=$$ \
              CTX_P= \
              ;
            ./sh-ci

    - store_artifacts:
        path: user-conf/.build/reports

    - store_test_results:
        path: reports

# Id: U-S:circleci/config.yml
